这是一份基于最新调研成果的 **Pocket Host 全周期技术演进路线图**。

根据你的战略调整（放弃强制自动化接入，接受“扫码/手动连接”），我们解除了项目最大的系统权限枷锁。这意味着 **iOS 设备作为主机（Host）在工程上完全可行**，只需采用特定的“反向发现”策略即可绕过苹果的广播屏蔽限制。

---

# Pocket Host 技术演进路线图 (The Roadmap)

本路线图将项目划分为四个阶段，从验证核心连接的 **MVP**，到实现动态加载的 **平台化**，最终达成 **生态化**。

## 阶段一：连接原型 (The "Handshake" Prototype)

**目标**：打通 Android 与 iOS 在“无路由、无互联网”环境下的双向 TCP/UDP 通讯，验证“任意设备做主机”的网络拓扑。

### 1. 核心技术栈

* **引擎**：Godot 4.x (C++ / GDScript)
* **网络库**：ENet (Godot 内置 High-level Multiplayer)
* **语言**：GDScript (业务逻辑), C++/Kotlin/Swift (原生插件)

### 2. 关键功能实现

#### A. 接入层：标准化二维码 (QR-Code Bootstrap)

不再依赖不稳定的蓝牙自动握手，而是建立一套基于 **WFA 标准** 的二维码流程：

* **Android Host**：调用 `startLocalOnlyHotspot`，获取系统生成的 SSID 和 随机密码，动态生成二维码：
`WIFI:T:WPA;S:AndroidShare_1234;P:RandomPass;;`
* **iOS Host**：由于 iOS 不允许 App 读取热点密码，UI 设计为“填空题”：用户开启个人热点 -> 在 App 内输入自己设置的密码 -> App 生成二维码供他人扫描。
* **Client 端**：使用系统相机或 App 内置扫码器扫描 -> 弹窗确认加入 Wi-Fi。

#### B. 发现层：网关反向推导 (Gateway Deduction) **(关键突破点)**

解决 iOS 做 Host 时广播（Broadcast/Multicast）被屏蔽的问题。

* **原理**：在热点模式下，**Host 设备必然是网关 (Gateway)**。Client 连接后，无需等待 Host 广播，而是主动查询本地网络详情，提取“默认网关”的 IP 地址。
* **流程**：
1. Client 加入热点。
2. Client 读取系统路由表（Android `LinkProperties`, iOS `sysctl`），获取网关 IP (通常是 `192.168.x.1` 或 `172.20.10.1`)。
3. Client **主动** 向该 IP 的固定端口（如 7777）发送 UDP 单播“Hello”包。
4. Host 收到包，记录 Client IP，握手完成。



### 3. 交付物

* 双端 Demo App：一台手机建房，另一台扫码进入，屏幕上显示“已连接”，并能互发文字消息。

---

## 阶段二：游戏化 MVP (The "Playable" Console)

**目标**：在不稳定的热点网络（高抖动）下，跑通一个多人实时互动游戏。

### 1. 核心技术栈

* **状态同步**：快照插值 (Snapshot Interpolation)
* **协议**：Reliable UDP (针对关键状态) + Unreliable UDP (针对位置/摇杆)

### 2. 关键功能实现

#### A. 混合权威架构 (Hybrid Authority)

为了适配“手机做服务器”的性能限制：

* **Host 端**：持有核心游戏逻辑（如：谁是卧底的词语分配、扑克牌的洗牌算法）。**不进行**复杂的物理碰撞模拟。
* **Client 端**：负责渲染、UI 动画和本地输入预测。
* **策略**：对于《高帧率斗地主》或《狼人杀》，Host 仅作为“发牌员”和“裁判”，负载极低，任何 iPhone 8 或 Android 中端机均可胜任。

#### B. 掉线重连与“无网”保活

* **Android**：使用 `ConnectivityManager.bindProcessToNetwork` 强制 App 流量走 Wi-Fi，防止系统因为“此 Wi-Fi 无互联网”而自动切换回 5G 数据，导致掉线。
* **iOS**：配置 `NEHotspotConfiguration(joinOnce: false)`。并在 App 内置一个微型 HTTP Server (Port 80)，拦截 iOS 的 `captive.apple.com` 探测请求，返回 `Success`，欺骗 iOS 系统认为“网络已通”，防止自动断开。

### 3. 交付物

* 内置一款无需下载的游戏（如《局域网炸弹人》或《谁是卧底》）。
* 验证在 iOS 热点（最多支持 13 个连接）下的稳定性。

---

## 阶段三：平台化架构 (The "Cartridge" System)

**目标**：实现核心业务逻辑：App 是“主机”，游戏是“卡带”。无需更新 App 即可分发新游戏。

### 1. 核心技术栈

* **资源包格式**：Godot `.pck` / `.zip`
* **脚本环境**：GDScript VM (解释执行，非 JIT)

### 2. 关键功能实现

#### A. 局域网 CDN 分发

* **场景**：Host 手机里有《3D 狼人杀》的最新版，而 Client 手机里没有。
* **流程**：
1. Client 连接 Host 后，版本校验失败。
2. Host 启动内置 HTTP 文件服务 (`SimpleHTTPServer`)。
3. Client 直接通过局域网 Wi-Fi 从 Host 下载 `.pck` 文件（速度极快，不耗流量）。
4. Client 下载完毕，动态挂载 `.pck`，无缝启动游戏。



#### B. 合规性控制 (App Store 4.7)

* **沙盒隔离**：确保下载的 `.pck` 只能访问游戏内的 API，无法读取通讯录、相册等隐私权限。
* **解释执行**：明确向 Apple 申诉应用使用的是 GDScript 解释器，而非二进制可执行代码，符合 2024 年更新后的审核指南 4.7 条款（允许模拟器/游戏引擎下载游戏）。

### 3. 交付物

* Pocket Host 启动器（Launcher App）。
* 可分离的.pck 游戏资源包。
* “面对面传游戏”功能。

---

## 阶段四：生态开放 (The UGC Platform) - *长期愿景*

**目标**：开放 SDK，允许第三方开发者为 Pocket Host 开发游戏。

### 1. 关键功能实现

* **API 封装**：提供 `PocketHostSDK`，封装底层的网络发现、状态同步逻辑。开发者只需关注 `OnPlayerJoin`、`SyncVariable` 等高层接口。
* **Web 编辑器**：提供简易的网页版编辑器，导出 `.phg` (Pocket Host Game) 格式。

---

# 总结：技术难点攻克表

| 难点 | 原始痛点 | 最新解决方案 | 风险等级 |
| --- | --- | --- | --- |
| **iOS 做主机** | iOS 屏蔽热点内的广播，Client 找不到 Host | **网关反向推导**：Client 连接后直接向“默认网关IP”发起单播握手。 | Low |
| **跨端连接** | Android/iOS Wi-Fi 协议不互通，自动化难 | **二维码标准流**：回归用户主动扫码，Android 自动生成，iOS 手动填密生成。 | Low |
| **无网断连** | 手机系统发现 Wi-Fi 没网会自动切回 5G | **路由绑定 & Captive Portal 欺骗**：代码级强制绑定 Socket 到 Wi-Fi 接口；伪装 HTTP 200 响应欺骗 iOS。 | Medium |
| **商店审核** | 禁止下载可执行代码 | **解释型脚本 (.pck)**：利用 GDScript 的非 JIT 特性，符合 App Store 4.7 "Mini Apps" 条款。 | Medium |
| **Host 发热** | 手机做服务器计算量大 | **混合权威**：Host 只算逻辑（裁判），Client 算画面和物理预测。降低 Host 负载。 | Low |

**建议起步点**：
不要一开始就做平台。先用 **Godot** 做一个单纯的 **Android 建房、iOS 扫码加入** 的《弹球》或《炸弹人》Demo。一旦验证了“网关反向推导”在 iOS 热点下的可靠性，最难的技术关卡就通过了。