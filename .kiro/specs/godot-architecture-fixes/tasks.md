# Godot 架构修复实施计划

## 概述

本实施计划将系统性地解决 PocketHost 项目中的 Godot 架构问题，包括单例配置、插件文件组织、节点生命周期管理等。

## 任务

- [x] 1. 配置单例系统
  - 在 project.godot 中添加 autoload 配置
  - 验证单例的全局访问功能
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 1.1 编写单例配置验证测试
  - **属性 1: 单例唯一性**
  - **验证: 需求 1.1, 1.2**

- [x] 2. 修复插件文件配置
  - [x] 2.1 移动 .gdip 文件到正确位置
    - 将 PocketHostPlugin.gdip 从 ios_plugin/bin/ 移动到 ios/plugins/
    - _需求: 2.1, 2.3_

  - [x] 2.2 验证插件文件结构
    - 确认 .xcframework 文件在正确位置
    - 验证 .gdip 文件格式正确性
    - _需求: 2.2, 2.4_

- [x] 2.3 编写插件配置验证测试
  - **属性 2: 插件文件一致性**
  - **验证: 需求 2.1, 2.2, 2.4**

- [x] 3. 修复节点生命周期管理
  - [x] 3.1 修改 ConnectionManager 初始化逻辑
    - 将 add_child 调用移到 call_deferred 中
    - 添加初始化状态检查
    - _需求: 3.1, 3.2, 3.5_

  - [x] 3.2 实现安全的测试工厂方法
    - 为测试环境提供安全的管理器创建方法
    - 添加测试模式标志
    - _需求: 3.4_

- [ ] 3.3 编写节点生命周期安全性测试
  - **属性 3: 节点生命周期安全性**
  - **验证: 需求 3.1, 3.2, 3.5**

- [x] 4. 改进测试架构
  - [x] 4.1 创建 GUT 兼容的测试类
    - 重构现有测试以继承 GutTest
    - 保持独立运行脚本的功能
    - _需求: 4.1, 4.2_

  - [x] 4.2 实现测试资源管理
    - 添加测试前后的资源清理
    - 确保测试间的隔离性
    - _需求: 4.4, 4.5_

- [x] 4.3 编写测试环境隔离性测试
  - **属性 5: 测试环境隔离性**
  - **验证: 需求 4.3, 4.5**

- [x] 5. 实现配置验证系统
  - [x] 5.1 添加启动时配置检查
    - 验证 autoload 配置的有效性
    - 检查插件文件的完整性
    - _需求: 5.1, 5.2_

  - [x] 5.2 实现错误报告和修复建议
    - 提供详细的错误信息
    - 生成修复指导文档
    - _需求: 5.3, 5.5_

- [x] 5.3 编写配置验证完整性测试
  - **属性 4: 配置验证完整性**
  - **验证: 需求 5.1, 5.5**

- [x] 6. 确保向后兼容性
  - [x] 6.1 验证现有 API 兼容性
    - 运行所有现有单元测试
    - 确认 API 调用方式不变
    - _需求: 6.1, 6.2_

  - [x] 6.2 创建迁移指南
    - 文档化架构变更
    - 提供最佳实践建议
    - _需求: 6.5_

- [x] 6.3 编写向后兼容性保持测试
  - **属性 6: 向后兼容性保持**
  - **验证: 需求 6.2, 6.4**

- [x] 7. 集成测试和验证
  - [x] 7.1 运行完整的测试套件
    - 执行所有单元测试和属性测试
    - 验证集成功能正常
    - _需求: 所有需求_

  - [x] 7.2 真机环境验证
    - 在 iOS 设备上测试插件加载
    - 验证单例系统在真机上的表现
    - _需求: 2.5, 1.4_

- [x] 8. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，确保可追溯性
- 属性测试使用 100 次迭代来验证正确性
- 集成测试需要在真机环境中进行最终验证