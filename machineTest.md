## PocketHost - Phase 1 核心连接功能测试文档

### 1. 文档目的
本文档旨在为 PocketHost 项目第一阶段（Phase 1）的核心连接功能提供一套标准的真机测试流程和验收标准。测试将验证 iOS 原生插件的功能以及 Godot 层网络逻辑的正确性。

### 2. 测试概述
*   **测试目标**: 验证两台 iOS 设备在无外部路由器环境下，通过“个人热点+二维码扫描”的方式，成功建立点对点（P2P）网络连接。
*   **测试范围**:
    *   **范围内**:
        *   Host 端（主机）二维码生成。
        *   Client 端（客户端）二维码扫描与解析。
        *   Client 端自动连接 Wi-Fi 热点。
        *   Client 端动态发现 Host 的 IP 地址（网关）。
        *   双方建立 ENet 连接。
        *   连接断开后的资源清理。
    *   **范围外**:
        *   UI/UX 的美观性与流畅度。
        *   游戏具体玩法逻辑。
        *   多于2个设备连接的场景。

### 3. 测试环境与准备

#### **3.1 硬件与软件**
| 项目 | 角色 | 型号/版本 | 备注 |
|---|---|---|---|
| **硬件** | Host (主机) | iPhone 15 Pro Max | |
| | Client (客户端) | iPad mini 6 | |
| | 构建/调试 | Mac 电脑 | |
| **软件** | 操作系统 | macOS (最新版) | |
| | 开发工具 | Xcode (最新版) | |
| | 游戏引擎 | Godot 4.3+ | |
| | 开发者账户 | Apple Developer Account | 用于设备签名 |

#### **3.2 网络环境**
*   **连接方式**: 使用 **iPhone 15 Pro Max** 的“个人热点”功能。
*   **要求**: 测试期间关闭两台设备的外部 Wi-Fi 连接，确保 Client 连接的是 Host 的热点。

#### **3.3 准备工作检查清单**
在开始测试前，请确保以下所有步骤已完成：

**iOS 插件构建:**
-   [ ] **编译原生插件**: `ios_plugin` 目录下的 Swift 代码已被成功编译为 `PocketHostPlugin.xcframework`。
-   [ ] **验证插件构建**: 运行 `ios_plugin/export_scripts/export_plugin.sh` 无错误。

**Godot 项目配置:**
-   [ ] **配置 Godot 导出**:
    -   [ ] 在 Godot 的 `项目 > 导出...` 中，已在 `插件` 部分添加并启用了 `PocketHostPlugin.gdip`。
    -   [ ] 在 Godot 的 `导出 > iOS` 预设中，已配置了有效的开发者签名信息（`身份` 和 `配置文件`）。
    -   [ ] 在 Godot 的 `导出 > iOS` 预设中，已添加了 `ios_plugin/Info.plist` 作为自定义 `Info.plist` 文件（或者将我生成的权限条目手动合并到您的 Xcode 项目的 `Info.plist` 中）。
-   [ ] **配置 Autoload**: 在 Godot 的 `项目设置 > Autoload` 中，已将 `iOSPluginBridge.gd` 添加为单例。其他核心管理器（`ConnectionManager` 等）也应根据最终设计添加。

**设备准备:**
-   [ ] **开发者证书**: 两台设备都已添加到开发者账户的设备列表
-   [ ] **系统版本**: 确认两台设备都运行 iOS/iPadOS 15.0+
-   [ ] **网络环境**: 关闭两台设备的其他 Wi-Fi 连接
-   [ ] **权限准备**: 了解测试过程中会请求相机和本地网络权限

**测试工具准备:**
-   [ ] **Xcode 连接**: 两台设备都通过 USB 连接到 Mac，可在 Xcode 中看到设备
-   [ ] **控制台访问**: 能够在 Xcode 中查看两台设备的实时日志
-   [ ] **测试二维码**: 准备一个标准 WFA 格式的测试二维码（可选，用于预验证）

### 4. 测试用例与执行步骤

#### **4.1 预验证步骤**
在开始正式测试前，建议先进行以下快速验证：

| 验证项目 | 操作 | 预期结果 |
|---------|------|---------|
| **应用启动** | 在两台设备上启动 PocketHost | 应用正常启动，无崩溃 |
| **插件状态** | 查看 Xcode 控制台日志 | 显示 "iOS Plugin Bridge: PocketHostPlugin found." |
| **权限准备** | 手动触发相机权限请求 | 系统弹出权限对话框 |
| **网络状态** | 检查两台设备的网络连接 | 已断开其他 Wi-Fi 连接 |
| **热点功能** | 在 iPhone 上开启个人热点 | 热点成功开启，可在设置中看到 |

#### **4.2 测试流程总览**
Host (iPhone) 开启热点并生成二维码 → Client (iPad) 扫描二维码 → Client 自动连接 Wi-Fi → Client 发现 Host IP → 双方建立 ENet 连接。

| 用例ID | 测试用例名称 | 角色 | 执行步骤 | 预期结果 | 实际结果 (Pass/Fail) |
|---|---|---|---|---|---|
| TC-01 | Host 端设置与二维码生成 | **Host** (iPhone) | 1. 在 `设置 > 个人热点` 中，开启个人热点。记录或设置一个简单的密码。<br>2. 打开 PocketHost 应用。<br>3. 进入“创建房间”界面，输入刚刚设置的热点密码，点击确认。 | 1. 应用无崩溃。<br>2. 屏幕上成功显示一个清晰的二维码。<br>3. Xcode 控制台或应用界面显示“等待玩家加入...”状态。 | |
| TC-02 | Client 端扫描与 Wi-Fi 连接 | **Client** (iPad) | 1. 打开 PocketHost 应用。<br>2. 进入“加入房间”界面。<br>3. 当应用请求相机权限时，选择“允许”。<br>4. 将摄像头对准 Host 屏幕上的二维码进行扫描。 | 1. 扫描成功后，`qr_code_scanned` 信号被触发（可在 Xcode 控制台看到日志）。<br>2. iPad 自动断开当前网络，并开始连接 iPhone 的热点。<br>3. 连接成功后，`wifi_connected` 信号被触发。<br>4. iPad 的状态栏显示已连接到 iPhone 的热点。 | |
| TC-03 | 网关发现与 ENet 连接 | **Client** (iPad) | (此步骤紧随 TC-02 自动发生)<br>1. 观察应用状态和 Xcode 日志。 | 1. `gateway_discovered` 信号被触发，并附带一个有效的 IP 地址（通常是 `172.20.10.1`）。<br>2. 应用状态变为“正在连接主机...”。<br>3. `ConnectionManager` 的 `connected_to_host` 信号被触发。<br>4. Host 和 Client 的应用界面最终都显示为“已连接”。 | |
| TC-04 | 连接稳定性验证 | **Host** & **Client** | 1. 保持两台设备连接，不要锁屏。<br>2. (如果已有简易聊天功能) 双方互相发送几条测试消息。 | 1. 连接在至少2分钟内保持稳定，没有断开。<br>2. 消息能够被另一方正确接收。 | |
| TC-05 | 断开连接与资源清理 | **Host** | 1. 在 iPhone 的“设置”中，手动关闭个人热点。 | 1. Client 端在心跳超时后（约3-5秒），应检测到连接断开。<br>2. Client 端的应用状态变为“连接已断开”。 | |
| | | **Client** | 2. 在 Client 应用中，执行返回或断开连接操作。 | 1. `removeWiFiConfiguration` 方法被调用（可在 Xcode 控制台看到日志）。<br>2. `wifi_removed` 信号被触发。<br>3. iPad 的 Wi-Fi 会自动断开与 iPhone 热点的连接。 | |

### 5. 验收标准
本次测试通过的最终标准是：
*   **所有测试用例（TC-01 至 TC-07）均成功（Pass）。**
*   **能够成功建立一个稳定的 ENet 连接**，为后续的游戏数据同步打下基础。

### 7. 补充测试用例

#### **7.1 性能和稳定性测试**
| 用例ID | 测试用例名称 | 执行步骤 | 预期结果 |
|---|---|---|---|
| TC-06 | 性能压力测试 | 1. 快速连续发送多条消息<br>2. 测试中文消息传输<br>3. 测试长消息传输（500+ 字符） | 1. 消息发送无丢失<br>2. 中文字符正确显示<br>3. 长消息完整传输<br>4. 网络延迟 < 100ms |
| TC-07 | 异常情况处理 | 1. Host 设备锁屏 30 秒<br>2. Client 设备锁屏 30 秒<br>3. 手动关闭/重启热点 | 1. 锁屏后应用正常恢复<br>2. 能检测到断线<br>3. 错误状态正确显示 |

#### **7.2 iPad 特定测试**
| 测试项目 | 验证内容 | 预期结果 |
|---------|---------|---------|
| 屏幕适配 | UI 在 iPad 分辨率下的显示 | 界面元素正确缩放，无变形 |
| 相机性能 | 后置相机扫描二维码 | 扫描速度快，识别准确 |
| 多方向支持 | 横屏/竖屏切换 | 应用能正确适应方向变化 |
| 性能表现 | A15 芯片下的运行流畅度 | 无卡顿，响应迅速 |

### 6. 问题记录与分析

#### **6.1 调试工具使用**
*   测试过程中，请保持两台设备都连接到 Mac 电脑，并打开 Xcode。
*   **Xcode 的控制台是排查问题的最重要工具**。所有来自 Swift 插件的 `print` 日志，以及 Godot 层的 `print` 输出，都会显示在这里。
*   如果某个步骤失败，请将 Xcode 控制台的**相关错误日志**记录下来，这将是定位问题的关键。

#### **6.2 常见问题与解决方案**

| 问题类型 | 症状 | 可能原因 | 解决方案 |
|---------|------|---------|---------|
| **插件未加载** | 控制台显示 "PocketHostPlugin not found" | 1. 插件未正确编译<br>2. 导出设置中未包含插件 | 1. 重新运行构建脚本<br>2. 检查 Godot 导出设置 |
| **权限被拒绝** | 相机或网络功能无法使用 | 用户拒绝了权限请求 | 前往 设置 > 隐私与安全性 手动开启权限 |
| **二维码扫描失败** | 扫描无响应或识别错误 | 1. 设备不支持 VisionKit<br>2. 二维码格式错误<br>3. 光线不足 | 1. 确认设备支持 iOS 15.0+<br>2. 验证 WFA 格式<br>3. 改善光线条件 |
| **Wi-Fi 连接失败** | 无法连接到热点 | 1. 热点未开启<br>2. 密码错误<br>3. 设备已连接其他网络 | 1. 确认热点状态<br>2. 重新输入密码<br>3. 断开其他连接 |
| **网关发现失败** | 无法获取 Host IP | 1. 未连接到热点<br>2. 网络权限问题<br>3. 路由表查询失败 | 1. 确认 Wi-Fi 连接状态<br>2. 检查本地网络权限<br>3. 重启网络连接 |
| **ENet 连接超时** | 无法建立游戏连接 | 1. 防火墙阻止<br>2. 端口被占用<br>3. 网络不稳定 | 1. 检查网络设置<br>2. 重启应用<br>3. 重新建立热点连接 |

#### **6.3 关键日志标识**

**成功日志示例:**
```
✅ 插件加载: "iOS Plugin Bridge: PocketHostPlugin found."
✅ 二维码扫描: "PocketHostPlugin: QR Code Scanned: WIFI:T:WPA;S:..."
✅ Wi-Fi 连接: "PocketHostPlugin: Successfully connected to WiFi: ..."
✅ 网关发现: "PocketHostPlugin: Discovered gateway IP: 172.20.10.1"
✅ ENet 连接: "ConnectionManager: Connected to host successfully"
```

**错误日志示例:**
```
❌ 插件问题: "PocketHostPlugin not found. Running in editor..."
❌ 权限问题: "DataScannerViewController is not available..."
❌ 网络问题: "WiFi connection failed: ..."
❌ 连接问题: "ENet connection failed: ..."
```

#### **6.4 测试结果记录表**

| 测试项目 | 预期行为 | 实际结果 | 日志摘要 | 问题描述 | 解决方案 |
|---------|---------|---------|---------|---------|---------|
| 插件加载 | 成功加载 | Pass/Fail | | | |
| 二维码生成 | 显示清晰二维码 | Pass/Fail | | | |
| 二维码扫描 | 成功解析 SSID/密码 | Pass/Fail | | | |
| Wi-Fi 连接 | 自动连接热点 | Pass/Fail | | | |
| 网关发现 | 获取有效 IP | Pass/Fail | | | |
| ENet 连接 | 建立稳定连接 | Pass/Fail | | | |
| 消息收发 | 双向通信正常 | Pass/Fail | | | |
| 断线处理 | 正确清理资源 | Pass/Fail | | | |
